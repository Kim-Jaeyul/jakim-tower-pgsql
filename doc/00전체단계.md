# 사전준비

1. **IP할당**

   | hostname            | external     | internal     |
   | ------------------- | ------------ | ------------ |
   | bastion.example.com | 192.168.0.30 | 192.168.1.30 |
   | tower1.example.com  | 192.168.0.31 | 192.168.1.31 |
   | tower2.example.com  | 192.168.0.32 | 192.168.1.32 |
   | tower3.example.com  | 192.168.0.33 | 192.168.1.33 |
   | db1.example.com     | 192.168.0.34 | 192.168.1.34 |
   | db2.example.com     | 192.168.0.35 | 192.168.1.35 |



2. **RHEL Version**

   ```
   [root@bastion ~]# cat /etc/redhat-release
   Red Hat Enterprise Linux release 8.3 (Ootpa)
   [root@bastion ~]#
   ```



3. **Red Hat Ansible Version**

   ```shell
   [root@bastion atower-pgsql]# ansible --version
   ansible 2.9.15
     config file = /root/atower-pgsql/ansible.cfg
     configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
     ansible python module location = /usr/lib/python3.6/site-packages/ansible
     executable location = /usr/bin/ansible
     python version = 3.6.8 (default, Aug 18 2020, 08:33:21) [GCC 8.3.1 20191121 (Red Hat 8.3.1-5)]
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ll
   total 379744
   ...
   drwxr-xr-x. 7 root root       230 Feb  9 05:46 ansible-tower-setup-bundle-3.8.1-1
   ...
   ```

   



# Bastion에 Offline 설치를 위한 Repository 및 관련 설치파일 준비

1. Ansible Tower Download

   ```sh
   [root@bastion ~]# wget https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-latest.el8.tar.gz
   --2021-02-09 01:40:42--  https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-latest.el8.tar.gz
   Resolving releases.ansible.com (releases.ansible.com)... 104.26.1.234, 172.67.68.251, 104.26.0.234, ...
   Connecting to releases.ansible.com (releases.ansible.com)|104.26.1.234|:443... connected.
   HTTP request sent, awaiting response... 200 OK
   Length: 388792591 (371M) [application/x-gzip]
   Saving to: ‘ansible-tower-setup-bundle-latest.el8.tar.gz’
   
   ansible-tower-setup-bundle-latest.el8.tar.gz        100%[=================================================================================================================>] 370.78M  9.43MB/s    in 40s
   
   2021-02-09 01:41:22 (9.36 MB/s) - ‘ansible-tower-setup-bundle-latest.el8.tar.gz’ saved [388792591/388792591]
   
   [root@bastion ~]#
   [root@bastion ~]# ls -lh
   total 9.2G
   -rw-------. 1 root root 1.3K Feb  9 01:14 anaconda-ks.cfg
   -rw-r--r--. 1 root root 371M Jan 13 20:46 ansible-tower-setup-bundle-latest.el8.tar.gz
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Desktop
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Documents
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Downloads
   -rw-r--r--. 1 root root 1.6K Feb  9 01:16 initial-setup-ks.cfg
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Music
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Pictures
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Public
   -rw-r--r--. 1 root root 8.9G Feb  9 01:54 rhel-8.3-x86_64-dvd.iso
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Templates
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Videos
   [root@bastion ~]#
   ```

   

2. RHEL Base ISO 준비

   ```shell
   [root@bastion ~]# ls -lh
   total 9.2G
   -rw-------. 1 root root 1.3K Feb  9 01:14 anaconda-ks.cfg
   -rw-r--r--. 1 root root 371M Jan 13 20:46 ansible-tower-setup-bundle-latest.el8.tar.gz
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Desktop
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Documents
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Downloads
   -rw-r--r--. 1 root root 1.6K Feb  9 01:16 initial-setup-ks.cfg
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Music
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Pictures
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Public
   -rw-r--r--. 1 root root 8.9G Feb  9 01:54 rhel-8.3-x86_64-dvd.iso
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Templates
   drwxr-xr-x. 2 root root    6 Feb  9 01:29 Videos
   [root@bastion ~]#
   ```



3. RHEL Base ISO mount

   ```shell
   [root@bastion ~]# mkdir /mnt/disc
   [root@bastion ~]# mount -r -o loop /root/rhel-8.3-x86_64-dvd.iso /mnt/disc/
   ```



4. 예제 repo file 복사

   ```shell
   [root@bastion ~]# cp /mnt/disc/media.repo /etc/yum.repos.d/rhel8disc.repo
   [root@bastion ~]# chmod 644 /etc/yum.repos.d/rhel8disc.repo
   ```



5. repo file 수정

   ```shell
   [root@bastion ~]# cat << EOF > /etc/yum.repos.d/rhel8disc.repo
   [RHEL8-Server-DVD-Appstream]
   name=Red Hat Enterprise Linux 8.3.0 (DVD) Appstream
   mediaid=None
   metadata_expire=-1
   gpgcheck=1
   cost=500
   baseurl=file:///mnt/disc/AppStream
   enabled=1
   gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
   
   [RHEL8-Server-DVD-BaseOS]
   name=Red Hat Enterprise Linux 8.3.0 (DVD) BaseOS
   mediaid=None
   metadata_expire=-1
   gpgcheck=1
   cost=500
   baseurl=file:///mnt/disc/BaseOS
   enabled=1
   gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
   EOF
   [root@bastion ~]#
   ```



6. repo 확인

   ```shell
   [root@bastion ~]# dnf repolist
   Updating Subscription Management repositories.
   Unable to read consumer identity
   
   This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
   
   repo id                                                                                                    repo name
   RHEL8-Server-DVD-Appstream                                                                                 Red Hat Enterprise Linux 8.3.0 (DVD) Appstream
   RHEL8-Server-DVD-BaseOS                                                                                    Red Hat Enterprise Linux 8.3.0 (DVD) BaseOS
   [root@bastion ~]#
   ```



7. httpd와 rsync 설치

   ```shell
   [root@bastion ~]# dnf install -y rsync httpd
   ...
   Complete!
   [root@bastion ~]#
   ```



8. umount DVD 후, http 경로로 다시 잡기

   ```shell
   [root@bastion ~]# mv /etc/yum.repos.d/rhel8disc.repo /etc/yum.repos.d/rhel8disc.repo.bak
   [root@bastion ~]#
   [root@bastion ~]# umount /mnt/disc
   [root@bastion ~]# rm -r /mnt/disc
   rm: remove directory '/mnt/disc'? y
   [root@bastion ~]#
   [root@bastion ~]# mkdir -p /var/www/html/cdrom/
   [root@bastion ~]#
   [root@bastion ~]# mount -o loop /root/rhel-8.3-x86_64-dvd.iso /media
   mount: /media: WARNING: device write-protected, mounted read-only.
   [root@bastion ~]#
   [root@bastion ~]# shopt -s dotglob
   [root@bastion ~]#
   [root@bastion ~]# cp -apvR /media/* /var/www/html/cdrom/
   ...
   [root@bastion ~]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cat /etc/httpd/conf/httpd.conf | grep -e ServerAdmin -e ServerName -e DocumentRoot -e Listen |grep -v "#"
   Listen 8080
   ServerAdmin root@192.168.1.30
   ServerName 192.168.1.30
   DocumentRoot "/var/www/html"
   [root@bastion ~]#
   [root@bastion ~]# httpd -t
   Syntax OK
   [root@bastion ~]# service httpd start
   Redirecting to /bin/systemctl start httpd.service
   [root@bastion ~]#
   [root@bastion ~]# systemctl status httpd
   ● httpd.service - The Apache HTTP Server
      Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
      Active: active (running) since Tue 2021-02-09 02:50:11 KST; 9s ago
        Docs: man:httpd.service(8)
    Main PID: 32213 (httpd)
      Status: "Running, listening on: port 80"
       Tasks: 213 (limit: 49296)
      Memory: 30.2M
      CGroup: /system.slice/httpd.service
              ├─32213 /usr/sbin/httpd -DFOREGROUND
              ├─32214 /usr/sbin/httpd -DFOREGROUND
              ├─32215 /usr/sbin/httpd -DFOREGROUND
              ├─32216 /usr/sbin/httpd -DFOREGROUND
              └─32217 /usr/sbin/httpd -DFOREGROUND
   
   Feb 09 02:50:11 bastion.example.com systemd[1]: Starting The Apache HTTP Server...
   Feb 09 02:50:11 bastion.example.com systemd[1]: Started The Apache HTTP Server.
   Feb 09 02:50:11 bastion.example.com httpd[32213]: Server configured, listening on: port 80
   [root@bastion ~]# systemctl enable httpd
   Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.
   [root@bastion ~]#
   [root@bastion ~]#
   [root@bastion ~]# systemctl status httpd
   ● httpd.service - The Apache HTTP Server
      Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
      Active: active (running) since Tue 2021-02-09 02:50:11 KST; 20s ago
        Docs: man:httpd.service(8)
    Main PID: 32213 (httpd)
      Status: "Running, listening on: port 80"
       Tasks: 213 (limit: 49296)
      Memory: 30.2M
      CGroup: /system.slice/httpd.service
              ├─32213 /usr/sbin/httpd -DFOREGROUND
              ├─32214 /usr/sbin/httpd -DFOREGROUND
              ├─32215 /usr/sbin/httpd -DFOREGROUND
              ├─32216 /usr/sbin/httpd -DFOREGROUND
              └─32217 /usr/sbin/httpd -DFOREGROUND
   
   Feb 09 02:50:11 bastion.example.com systemd[1]: Starting The Apache HTTP Server...
   Feb 09 02:50:11 bastion.example.com systemd[1]: Started The Apache HTTP Server.
   Feb 09 02:50:11 bastion.example.com httpd[32213]: Server configured, listening on: port 80
   [root@bastion ~]#
   [root@bastion ~]# ls -lZ /var/www/html/cdrom/
   total 56
   dr-xr-xr-x. 4 root root system_u:object_r:iso9660_t:s0    38 Oct  9 19:40 AppStream
   dr-xr-xr-x. 4 root root system_u:object_r:iso9660_t:s0    38 Oct  9 19:40 BaseOS
   dr-xr-xr-x. 3 root root system_u:object_r:iso9660_t:s0    18 Oct  9 19:40 EFI
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0  8266 Oct  9 19:37 EULA
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0  1455 Oct  9 19:37 extra_files.json
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0 18092 Oct  9 19:37 GPL
   dr-xr-xr-x. 3 root root system_u:object_r:iso9660_t:s0    76 Oct  9 19:40 images
   dr-xr-xr-x. 2 root root system_u:object_r:iso9660_t:s0   256 Oct  9 19:40 isolinux
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0   103 Oct  9 19:37 media.repo
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0  1669 Oct  9 19:37 RPM-GPG-KEY-redhat-beta
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0  5134 Oct  9 19:37 RPM-GPG-KEY-redhat-release
   -r--r--r--. 1 root root system_u:object_r:iso9660_t:s0  1796 Oct  9 19:40 TRANS.TBL
   [root@bastion ~]#
   [root@bastion ~]# restorecon -Rv /var/www/html
   ...
   [root@bastion ~]# ls -lZ /var/www/html/cdrom/
   total 56
   dr-xr-xr-x. 4 root root system_u:object_r:httpd_sys_content_t:s0    38 Oct  9 19:40 AppStream
   dr-xr-xr-x. 4 root root system_u:object_r:httpd_sys_content_t:s0    38 Oct  9 19:40 BaseOS
   dr-xr-xr-x. 3 root root system_u:object_r:httpd_sys_content_t:s0    18 Oct  9 19:40 EFI
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0  8266 Oct  9 19:37 EULA
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0  1455 Oct  9 19:37 extra_files.json
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0 18092 Oct  9 19:37 GPL
   dr-xr-xr-x. 3 root root system_u:object_r:httpd_sys_content_t:s0    76 Oct  9 19:40 images
   dr-xr-xr-x. 2 root root system_u:object_r:httpd_sys_content_t:s0   256 Oct  9 19:40 isolinux
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0   103 Oct  9 19:37 media.repo
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0  1669 Oct  9 19:37 RPM-GPG-KEY-redhat-beta
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0  5134 Oct  9 19:37 RPM-GPG-KEY-redhat-release
   -r--r--r--. 1 root root system_u:object_r:httpd_sys_content_t:s0  1796 Oct  9 19:40 TRANS.TBL
   [root@bastion ~]#
   [root@bastion ~]# cat << EOF > /etc/yum.repos.d/BaseOS.repo
   > [RHEL8-Server-DVD-Appstream]
   > name=Red Hat Enterprise Linux 8.3.0 (DVD) Appstream
   > enabled=1
   > gpgcheck=0
   > baseurl=http://192.168.1.30:8080/cdrom/AppStream/
   >
   > [RHEL8-Server-DVD-BaseOS]
   > name=Red Hat Enterprise Linux 8.3.0 (DVD) BaseOS
   > enabled=1
   > gpgcheck=0
   > baseurl=http://192.168.1.30:8080/cdrom/BaseOS/
   > EOF
   [root@bastion ~]#
   [root@bastion ~]# firewall-cmd --list-all
   public (active)
     target: default
     icmp-block-inversion: no
     interfaces: enp1s0 enp2s0
     sources:
     services: cockpit dhcpv6-client ssh
     ports:
     protocols:
     masquerade: no
     forward-ports:
     source-ports:
     icmp-blocks:
     rich rules:
   [root@bastion ~]# firewall-cmd --add-service=http --perm
   success
   [root@bastion ~]# firewall-cmd --reload
   success
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# firewall-cmd --add-port=8080/tcp --perm
   success
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# firewall-cmd --reload
   success
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# firewall-cmd --list-all
   public (active)
     target: default
     icmp-block-inversion: no
     interfaces: enp1s0 enp2s0
     sources:
     services: cockpit dhcpv6-client http ssh
     ports: 80/tcp 443/tcp 8080/tcp
     protocols:
     masquerade: no
     forward-ports:
     source-ports:
     icmp-blocks:
     rich rules:
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ~]# systemctl restart httpd
   [root@bastion ~]# systemctl status httpd
   ● httpd.service - The Apache HTTP Server
      Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 03:34:14 KST; 5s ago
        Docs: man:httpd.service(8)
    Main PID: 42530 (httpd)
      Status: "Started, listening on: port 8080"
       Tasks: 213 (limit: 49296)
      Memory: 31.9M
      CGroup: /system.slice/httpd.service
              ├─42530 /usr/sbin/httpd -DFOREGROUND
              ├─42533 /usr/sbin/httpd -DFOREGROUND
              ├─42534 /usr/sbin/httpd -DFOREGROUND
              ├─42535 /usr/sbin/httpd -DFOREGROUND
              └─42536 /usr/sbin/httpd -DFOREGROUND
   
   Feb 09 03:34:14 bastion.example.com systemd[1]: Starting The Apache HTTP Server...
   Feb 09 03:34:14 bastion.example.com systemd[1]: Started The Apache HTTP Server.
   Feb 09 03:34:14 bastion.example.com httpd[42530]: Server configured, listening on: port 8080
   [root@bastion ~]#
   [root@bastion ~]# dnf clean all
   Updating Subscription Management repositories.
   Unable to read consumer identity
   
   This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
   
   13 files removed
   [root@bastion ~]#
   [root@bastion ~]# rm -rf /var/cache/yum/*
   [root@bastion ~]# dnf makecache
   Updating Subscription Management repositories.
   Unable to read consumer identity
   
   This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
   
   Red Hat Enterprise Linux 8.3.0 (DVD) Appstream                                                                                                                                                           165 MB/s | 6.3 MB     00:00
   Red Hat Enterprise Linux 8.3.0 (DVD) BaseOS                                                                                                                                                              107 MB/s | 2.3 MB     00:00
   Last metadata expiration check: 0:00:01 ago on Tue 09 Feb 2021 03:02:29 AM KST.
   Metadata cache created.
   [root@bastion ~]# dnf repolist
   Updating Subscription Management repositories.
   Unable to read consumer identity
   
   This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
   
   repo id                                                                                                    repo name
   RHEL8-Server-DVD-Appstream                                                                                 Red Hat Enterprise Linux 8.3.0 (DVD) Appstream
   RHEL8-Server-DVD-BaseOS                                                                                    Red Hat Enterprise Linux 8.3.0 (DVD) BaseOS
   [root@bastion ~]#
   ```

   

# Bastion에 ansible 설치

1. 설치파일 압축해제

   ```shell
   [root@bastion ~]# tar xzf ansible-tower-setup-bundle-latest.el8.tar.gz
   [root@bastion ~]# cd ansible-tower-setup-bundle-3.8.1-1/
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ll
   total 60
   -rw-r--r--.  1 root root   626 Jan 13 20:43 backup.yml
   drwxr-xr-x.  4 root root    28 Jan 13 20:44 bundle
   drwxr-xr-x.  3 root root    33 Jan 13 20:44 collections
   drwxr-xr-x.  2 root root    17 Jan 13 20:43 group_vars
   -rw-r--r--.  1 root root  8521 Jan 13 20:43 install.yml
   -rw-r--r--.  1 root root  2915 Jan 13 20:43 inventory
   drwxr-xr-x.  3 root root  8192 Jan 13 20:43 licenses
   -rw-r--r--.  1 root root  2506 Jan 13 20:43 README.md
   -rw-r--r--.  1 root root  1335 Jan 13 20:43 rekey.yml
   -rw-r--r--.  1 root root  3492 Jan 13 20:43 restore.yml
   drwxr-xr-x. 21 root root  4096 Jan 13 20:43 roles
   -rwxr-xr-x.  1 root root 10819 Jan 13 20:43 setup.sh
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```

2. inventory file 수정

   ```shell
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cat inventory | grep -e admin_password -e pg_password | grep -v automationhub
   admin_password='Redhat1!'
   pg_password='Redhat1!'
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```

3. 설치 수행

   ```shell
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# curl google.com
   curl: (6) Could not resolve host: google.com
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ll
   total 60
   -rw-r--r--.  1 root root   626 Jan 13 20:43 backup.yml
   drwxr-xr-x.  4 root root    28 Jan 13 20:44 bundle
   drwxr-xr-x.  3 root root    33 Jan 13 20:44 collections
   drwxr-xr-x.  2 root root    17 Jan 13 20:43 group_vars
   -rw-r--r--.  1 root root  8521 Jan 13 20:43 install.yml
   -rw-r--r--.  1 root root  2931 Feb  9 03:15 inventory
   drwxr-xr-x.  3 root root  8192 Jan 13 20:43 licenses
   -rw-r--r--.  1 root root  2506 Jan 13 20:43 README.md
   -rw-r--r--.  1 root root  1335 Jan 13 20:43 rekey.yml
   -rw-r--r--.  1 root root  3492 Jan 13 20:43 restore.yml
   drwxr-xr-x. 21 root root  4096 Jan 13 20:43 roles
   -rwxr-xr-x.  1 root root 10819 Jan 13 20:43 setup.sh
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ./setup.sh
   ...
   
   PLAY RECAP ******************************************************************************************************************************************************************************************************************************
   localhost                  : ok=174  changed=38   unreachable=0    failed=0    skipped=86   rescued=0    ignored=0
   
   The setup process completed successfully.
   Setup log saved to /var/log/tower/setup-2021-02-09-03:37:05.log.
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```



# Bastion에 dnsmasq 설정(optional)

1. 방화벽 open

   ```shell
   [root@bastion ~]# firewall-cmd --add-service=dns --perm
   success
   [root@bastion ~]# firewall-cmd --reload
   success
   [root@bastion ~]# firewall-cmd --list-all
   public (active)
     target: default
     icmp-block-inversion: no
     interfaces: enp1s0 enp2s0
     sources:
     services: cockpit dhcpv6-client dns http ssh
     ports: 80/tcp 443/tcp 8080/tcp
     protocols:
     masquerade: no
     forward-ports:
     source-ports:
     icmp-blocks:
     rich rules:
   [root@bastion ~]#
   ```

2. /etc/dnsmasq.conf 설정

   ```shell
   [root@bastion ~]# cat /etc/dnsmasq.conf |grep -v "#"
   listen-address=::1,127.0.0.1,192.168.1.30
   interface=enp2s0
   except-interface=virbr0
   no-dhcp-interface=virbr0
   bind-interfaces
   
   address=/example.com/127.0.0.1
   address=/example.com/192.168.1.30
   
   expand-hosts
   domain=example.com
   
   conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig
   [root@bastion ~]#
   [root@bastion ~]# ip a
   1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
       link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
       inet 127.0.0.1/8 scope host lo
          valid_lft forever preferred_lft forever
       inet6 ::1/128 scope host
          valid_lft forever preferred_lft forever
   2: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
       link/ether 56:6f:c9:f7:00:02 brd ff:ff:ff:ff:ff:ff
       inet 192.168.0.30/24 brd 192.168.0.255 scope global noprefixroute enp1s0
          valid_lft forever preferred_lft forever
       inet6 fe80::546f:c9ff:fef7:2/64 scope link
          valid_lft forever preferred_lft forever
   3: enp2s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
       link/ether 56:6f:c9:f7:00:03 brd ff:ff:ff:ff:ff:ff
       inet 192.168.1.30/24 brd 192.168.1.255 scope global noprefixroute enp2s0
          valid_lft forever preferred_lft forever
       inet6 fe80::546f:c9ff:fef7:3/64 scope link
          valid_lft forever preferred_lft forever
   4: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
       link/ether 52:54:00:12:81:2d brd ff:ff:ff:ff:ff:ff
       inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
          valid_lft forever preferred_lft forever
   5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000
       link/ether 52:54:00:12:81:2d brd ff:ff:ff:ff:ff:ff
   [root@bastion ~]#
   [root@bastion ~]# dnsmasq --test
   dnsmasq: syntax check OK.
   [root@bastion ~]#
   ```

3. /etc/hosts 에 추가

   ```
   [root@bastion ~]# cat /etc/hosts
   127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
   ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
   
   192.168.1.30 bastion.example.com bastion
   192.168.1.31 tower1.example.com tower1
   192.168.1.32 tower2.example.com tower2
   192.168.1.33 tower3.example.com tower3
   192.168.1.34 db1.example.com db1
   192.168.1.35 db2.example.com db2
   [root@bastion ~]#
   ```

4. dnsmasq 실행

   ```shell
   [root@bastion ~]# systemctl start dnsmasq
   [root@bastion ~]# systemctl enable dnsmasq
   Created symlink /etc/systemd/system/multi-user.target.wants/dnsmasq.service → /usr/lib/systemd/system/dnsmasq.service.
   [root@bastion ~]# systemctl status dnsmasq
   ● dnsmasq.service - DNS caching server.
      Loaded: loaded (/usr/lib/systemd/system/dnsmasq.service; enabled; vendor preset: disabled)
      Active: active (running) since Tue 2021-02-09 03:54:44 KST; 14s ago
    Main PID: 46965 (dnsmasq)
       Tasks: 1 (limit: 49296)
      Memory: 812.0K
      CGroup: /system.slice/dnsmasq.service
              └─46965 /usr/sbin/dnsmasq -k
   
   Feb 09 03:54:44 bastion.example.com systemd[1]: Started DNS caching server..
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: listening on enp2s0(#3): 192.168.1.30
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: listening on lo(#1): 127.0.0.1
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: listening on enp2s0(#3): fe80::546f:c9ff:fef7:3%enp2s0
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: listening on lo(#1): ::1
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: started, version 2.79 cachesize 150
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: compile time options: IPv6 GNU-getopt DBus no-i18n IDN2 DHCP DHCPv6 no-Lua TFTP no-conntrack ipset auth DNSSEC loop-detect inotify
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: no servers found in /etc/resolv.conf, will retry
   Feb 09 03:54:44 bastion.example.com dnsmasq[46965]: read /etc/hosts - 8 addresses
   [root@bastion ~]#
   ```

   

# Bastion의 public key 배포

1. key generate

   ```shell
   [root@bastion ~]# ssh-key
   ssh-keygen   ssh-keyscan
   [root@bastion ~]# ssh-keygen
   Generating public/private rsa key pair.
   Enter file in which to save the key (/root/.ssh/id_rsa):
   Created directory '/root/.ssh'.
   Enter passphrase (empty for no passphrase):
   Enter same passphrase again:
   Your identification has been saved in /root/.ssh/id_rsa.
   Your public key has been saved in /root/.ssh/id_rsa.pub.
   The key fingerprint is:
   SHA256:p3jpR0Zl4TOUqADYXm54MX0NV0r77oMEg3KJJRnlToI root@bastion.example.com
   The key's randomart image is:
   +---[RSA 3072]----+
   |   o...=. .+=+.  |
   |  . ..B.o o==o   |
   |   .E+.Bo= o*    |
   |    o *+= +  +   |
   |     o oS..o  .  |
   |       . +o ..   |
   |      . +o . ..  |
   |       o  . ...  |
   |        ..    .. |
   +----[SHA256]-----+
   [root@bastion ~]#
   [root@bastion ~]# ssh-copy-id bastion
   ...
   [root@bastion ~]# ssh-copy-id tower1
   ...
   [root@bastion ~]# ssh-copy-id tower2
   ...
   [root@bastion ~]# ssh-copy-id tower3
   ...
   [root@bastion ~]# ssh-copy-id db1
   ...
   [root@bastion ~]# ssh-copy-id db2
   ...
   [root@bastion ~]#
   ```



# 모든 노드 repository 설정

1. repository copy

   ```shell
   [root@bastion ~]# scp /etc/yum.repos.d/BaseOS.repo tower1:/etc/yum.repos.d/
   BaseOS.repo                                                                                                                                                                                            100%  296    93.6KB/s   00:00
   [root@bastion ~]# scp /etc/yum.repos.d/BaseOS.repo tower2:/etc/yum.repos.d/
   BaseOS.repo                                                                                                                                                                                            100%  296    44.4KB/s   00:00
   [root@bastion ~]# scp /etc/yum.repos.d/BaseOS.repo tower3:/etc/yum.repos.d/
   BaseOS.repo                                                                                                                                                                                            100%  296   109.1KB/s   00:00
   [root@bastion ~]# scp /etc/yum.repos.d/BaseOS.repo db1:/etc/yum.repos.d/
   BaseOS.repo                                                                                                                                                                                            100%  296    48.2KB/s   00:00
   [root@bastion ~]# scp /etc/yum.repos.d/BaseOS.repo db2:/etc/yum.repos.d/
   BaseOS.repo                                                                                                                                                                                            100%  296    51.4KB/s   00:00
   [root@bastion ~]#
   ```



# postgresql 설치하기(host : db1)

1. postgresql 설치

   ```shell
   [root@bastion ~]# ssh db1
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 01:54:02 2021
   [root@db1 ~]#
   [root@db1 ~]# yum module list | grep postgresql
   postgresql           9.6          client, server [d]                       PostgreSQL server and client module   
   postgresql           10 [d]       client, server [d]                       PostgreSQL server and client module   
   postgresql           12           client, server [d]                       PostgreSQL server and client module   
   [root@db1 ~]#
   [root@db1 ~]# dnf module install -y postgresql
   ...
   Installed:
     libpq-12.4-1.el8_2.x86_64
     postgresql-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
     postgresql-server-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   
   Complete!
   [root@db1 ~]#
   [root@db1 ~]# rpm -qa |grep postgresql
   postgresql-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   postgresql-server-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   [root@db1 ~]#
   ```

2. postgresql 설정

   ```shell
   [root@db1 ~]# postgresql-setup --initdb
    * Initializing database in '/var/lib/pgsql/data'
    * Initialized, logs are in /var/lib/pgsql/initdb_postgresql.log
   [root@db1 ~]#
   [root@db1 ~]# firewall-cmd --add-port=5432/tcp --perm
   success
   [root@db1 ~]# firewall-cmd --reload
   success
   [root@db1 ~]#
   ```

3. postgresql 서비스 시작

   ```shell
   [root@db1 /]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
      Active: inactive (dead)
   [root@db1 /]#
   [root@db1 /]#
   [root@db1 /]# systemctl enable postgresql.service
   Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service → /usr/lib/systemd/system/postgresql.service.
   [root@db1 /]# systemctl start postgresql.service
   [root@db1 /]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) since Tue 2021-02-09 04:22:19 KST; 2s ago
     Process: 33950 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 33953 (postmaster)
       Tasks: 8 (limit: 49295)
      Memory: 16.8M
      CGroup: /system.slice/postgresql.service
              ├─33953 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─33954 postgres: logger process
              ├─33956 postgres: checkpointer process
              ├─33957 postgres: writer process
              ├─33958 postgres: wal writer process
              ├─33959 postgres: autovacuum launcher process
              ├─33960 postgres: stats collector process
              └─33961 postgres: bgworker: logical replication launcher
   
   Feb 09 04:22:19 db1.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.947 KST [33953] LOG:  listening on IPv6 a>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.947 KST [33953] LOG:  listening on IPv4 a>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.952 KST [33953] LOG:  listening on Unix s>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.962 KST [33953] LOG:  listening on Unix s>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.979 KST [33953] LOG:  redirecting log out>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.979 KST [33953] HINT:  Future log output >
   Feb 09 04:22:19 db1.example.com systemd[1]: Started PostgreSQL database server.
   [root@db1 /]#
   ```

4. Ansible Tower에 필요한 User 생성

   ```shell
   [root@db1 ~]# su - postgres
   [postgres@db1 ~]$ pwd
   /var/lib/pgsql
   [postgres@db1 ~]$
   [postgres@db1 ~]$
   [postgres@db1 ~]$ ls -la
   total 16
   drwx------.  5 postgres postgres   97 Feb  9 04:19 .
   drwxr-xr-x. 61 root     root     4096 Feb  9 04:12 ..
   drwx------.  2 postgres postgres    6 Aug 25 23:20 backups
   -rw-r--r--.  1 postgres postgres   85 Aug 25 23:20 .bash_profile
   drwx------.  2 postgres postgres    6 Feb  9 04:19 .cache
   drwx------. 21 postgres postgres 4096 Feb  9 04:22 data
   -rw-------.  1 postgres postgres  901 Feb  9 04:19 initdb_postgresql.log
   [postgres@db1 ~]$
   [postgres@db1 ~]$ psql
   psql (10.14)
   Type "help" for help.
   
   postgres=# CREATE ROLE awxdbuser1 WITH LOGIN encrypted PASSWORD 'redhat123' VALID UNTIL 'infinity';
   CREATE ROLE
   postgres=#
   postgres=# CREATE USER replica REPLICATION LOGIN ENCRYPTED PASSWORD 'redhat123';
   CREATE ROLE
   postgres=#
   postgres=# \du
                                       List of roles
    Role name  |                         Attributes                         | Member of
   ------------+------------------------------------------------------------+-----------
    awxdbuser1 | Password valid until infinity                              | {}
    postgres   | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
    replica    | Replication                                                | {}
   
   postgres=#
   postgres=# CREATE DATABASE tower1 WITH ENCODING='UTF8' OWNER=awxdbuser1 CONNECTION LIMIT=-1;
   CREATE DATABASE
   postgres=#
   postgres=# \l
                                      List of databases
      Name    |   Owner    | Encoding |   Collate   |    Ctype    |   Access privileges
   -----------+------------+----------+-------------+-------------+-----------------------
    postgres  | postgres   | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
    template0 | postgres   | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
              |            |          |             |             | postgres=CTc/postgres
    template1 | postgres   | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
              |            |          |             |             | postgres=CTc/postgres
    tower1    | awxdbuser1 | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
   (4 rows)
   
   postgres=#
   postgres=# \q
   [postgres@db1 ~]$
   ```

5. postgresql 의 listening IP와 postgresql Client Authentication 변경

   ```shell
   [postgres@db1 ~]$ grep listen_addresses /var/lib/pgsql/data/postgresql.conf
   #listen_addresses = 'localhost'         # what IP address(es) to listen on;
   [postgres@db1 ~]$
   [postgres@db1 ~]$ vim /var/lib/pgsql/data/postgresql.conf
   [postgres@db1 ~]$
   [postgres@db1 ~]$ grep listen_addresses /var/lib/pgsql/data/postgresql.conf
   listen_addresses = '*'          # what IP address(es) to listen on;
   #listen_addresses = 'localhost'         # what IP address(es) to listen on;
   [postgres@db1 ~]$
   [postgres@db1 ~]$ vim /var/lib/pgsql/data/pg_hba.conf
   ...
   # TYPE  DATABASE        USER            ADDRESS                 METHOD
   
   # "local" is for Unix domain socket connections only
   local   all             all                                     peer
   # IPv4 local connections:
   host    all             all             127.0.0.1/32            ident
   host    all             awxdbuser1      192.168.1.31/32         md5
   host    all             awxdbuser1      192.168.1.32/32         md5
   host    all             awxdbuser1      192.168.1.33/32         md5
   host    all             awxdbuser1      192.168.1.34/32         md5
   host    all             awxdbuser1      192.168.1.35/32         md5
   # IPv6 local connections:
   host    all             all             ::1/128                 ident
   # Allow replication connections from localhost, by a user with the
   # replication privilege.
   local   replication     all                                     peer
   host    replication     all             127.0.0.1/32            ident
   host    replication     all             ::1/128                 ident
   host    replication     replica         192.168.1.34/32         trust
   host    replication     replica         192.168.1.35/32         trust
   [postgres@db1 ~]$
   [postgres@db1 ~]$ exit
   logout
   [root@db1 ~]#
   [root@db1 ~]#
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) since Tue 2021-02-09 04:22:19 KST; 38min ago
     Process: 33950 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 33953 (postmaster)
       Tasks: 8 (limit: 49295)
      Memory: 26.9M
      CGroup: /system.slice/postgresql.service
              ├─33953 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─33954 postgres: logger process
              ├─33956 postgres: checkpointer process
              ├─33957 postgres: writer process
              ├─33958 postgres: wal writer process
              ├─33959 postgres: autovacuum launcher process
              ├─33960 postgres: stats collector process
              └─33961 postgres: bgworker: logical replication launcher
   
   Feb 09 04:22:19 db1.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.947 KST [33953] LOG:  listening on IPv6 a>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.947 KST [33953] LOG:  listening on IPv4 a>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.952 KST [33953] LOG:  listening on Unix s>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.962 KST [33953] LOG:  listening on Unix s>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.979 KST [33953] LOG:  redirecting log out>
   Feb 09 04:22:19 db1.example.com postmaster[33953]: 2021-02-09 04:22:19.979 KST [33953] HINT:  Future log output >
   Feb 09 04:22:19 db1.example.com systemd[1]: Started PostgreSQL database server.
   [root@db1 ~]#
   [root@db1 ~]#
   [root@db1 ~]# systemctl restart postgresql.service
   [root@db1 ~]#
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 05:01:31 KST; 2s ago
     Process: 34444 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 34448 (postmaster)
       Tasks: 8 (limit: 49295)
      Memory: 17.0M
      CGroup: /system.slice/postgresql.service
              ├─34448 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─34449 postgres: logger process
              ├─34451 postgres: checkpointer process
              ├─34452 postgres: writer process
              ├─34453 postgres: wal writer process
              ├─34454 postgres: autovacuum launcher process
              ├─34455 postgres: stats collector process
              └─34456 postgres: bgworker: logical replication launcher
   
   Feb 09 05:01:31 db1.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.348 KST [34448] LOG:  listening on IPv4 a>
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.348 KST [34448] LOG:  listening on IPv6 a>
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.352 KST [34448] LOG:  listening on Unix s>
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.360 KST [34448] LOG:  listening on Unix s>
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.378 KST [34448] LOG:  redirecting log out>
   Feb 09 05:01:31 db1.example.com postmaster[34448]: 2021-02-09 05:01:31.378 KST [34448] HINT:  Future log output >
   Feb 09 05:01:31 db1.example.com systemd[1]: Started PostgreSQL database server.
   [root@db1 ~]#
   ```



# postgresql 설치하기(host : db2)

1. postgresql 설치

   ```shell
   [root@db1 ~]# exit
   logout
   Connection to db1 closed.
   [root@bastion ~]#
   [root@bastion ~]# ssh db2
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 01:58:16 2021
   [root@db2 ~]#
   [root@db2 ~]# dnf module list |grep postgresql
   postgresql           9.6          client, server [d]                       PostgreSQL server and client module   
   postgresql           10 [d]       client, server [d]                       PostgreSQL server and client module   
   postgresql           12           client, server [d]                       PostgreSQL server and client module   
   [root@db2 ~]#
   [root@db2 ~]# dnf module install -y postgresql
   ...
   Installed:
     libpq-12.4-1.el8_2.x86_64
     postgresql-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
     postgresql-server-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   
   Complete!
   [root@db2 ~]#
   [root@db2 ~]# rpm -qa|grep postgresql
   postgresql-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   postgresql-server-10.14-1.module+el8.2.0+7801+be0fed80.x86_64
   [root@db2 ~]#
   [root@db2 ~]# firewall-cmd --add-port=5432/tcp --permanent
   success
   [root@db2 ~]# firewall-cmd --reload
   success
   [root@db2 ~]# firewall-cmd --list-all
   public (active)
     target: default
     icmp-block-inversion: no
     interfaces: enp1s0 enp2s0
     sources:
     services: cockpit dhcpv6-client ssh
     ports: 5432/tcp
     protocols:
     masquerade: no
     forward-ports:
     source-ports:
     icmp-blocks:
     rich rules:
   [root@db2 ~]#
   ```



# Ansible Tower 설치(host : Bastion)

1. Download pgsql role

   ```shell
   [root@bastion ~]# git clone https://github.com/mh2ict/atower-pgsql.git
   Cloning into 'atower-pgsql'...
   remote: Enumerating objects: 3, done.
   remote: Counting objects: 100% (3/3), done.
   remote: Compressing objects: 100% (2/2), done.
   remote: Total 67 (delta 0), reused 3 (delta 0), pack-reused 64
   Unpacking objects: 100% (67/67), 26.44 KiB | 443.00 KiB/s, done.
   [root@bastion ~]#
   [root@bastion ~]# cd atower-pgsql/
   [root@bastion atower-pgsql]# ll
   total 56
   -rw-r--r--. 1 root root 19966 Feb  9 05:14 ansible.cfg
   -rw-r--r--. 1 root root  3747 Feb  9 05:14 check-pgsql-replication.yml
   -rw-r--r--. 1 root root   227 Feb  9 05:14 hosts
   -rw-r--r--. 1 root root  2583 Feb  9 05:14 pgsql-promote.yml
   -rw-r--r--. 1 root root    15 Feb  9 05:14 README.md
   drwxr-xr-x. 5 root root    68 Feb  9 05:14 roles
   -rw-r--r--. 1 root root   226 Feb  9 05:14 setup-pgsql-replication.yml
   -rw-r--r--. 1 root root   487 Feb  9 05:14 tower-set-inventory-ha.yml
   -rw-r--r--. 1 root root  1673 Feb  9 05:14 tower-setup.yml
   -rw-r--r--. 1 root root   154 Feb  9 05:14 tower-start-services.yml
   -rw-r--r--. 1 root root   152 Feb  9 05:14 tower-stop-services.yml
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cd ..
   [root@bastion ~]# ll
   total 9624368
   -rw-------. 1 root root       1328 Feb  9 01:14 anaconda-ks.cfg
   drwxr-xr-x. 7 root root        209 Feb  9 03:39 ansible-tower-setup-bundle-3.8.1-1
   -rw-r--r--. 1 root root  388792591 Jan 13 20:46 ansible-tower-setup-bundle-latest.el8.tar.gz
   drwxr-xr-x. 4 root root       4096 Feb  9 05:14 atower-pgsql
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Desktop
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Documents
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Downloads
   -rw-r--r--. 1 root root       1600 Feb  9 01:16 initial-setup-ks.cfg
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Music
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Pictures
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Public
   -rw-r--r--. 1 root root 9466544128 Feb  9 01:54 rhel-8.3-x86_64-dvd.iso
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Templates
   drwxr-xr-x. 2 root root          6 Feb  9 01:29 Videos
   [root@bastion ~]# cp ansible-tower-setup-bundle-latest.el8.tar.gz atower-pgsql/
   [root@bastion ~]#
   [root@bastion ~]# cd atower-pgsql/
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# tar xzf ansible-tower-setup-bundle-latest.el8.tar.gz
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ll
   total 379740
   -rw-r--r--. 1 root root     19966 Feb  9 05:14 ansible.cfg
   drwxr-xr-x. 7 root root       209 Jan 13 20:44 ansible-tower-setup-bundle-3.8.1-1
   -rw-r--r--. 1 root root 388792591 Feb  9 05:18 ansible-tower-setup-bundle-latest.el8.tar.gz
   -rw-r--r--. 1 root root      3747 Feb  9 05:14 check-pgsql-replication.yml
   -rw-r--r--. 1 root root       227 Feb  9 05:14 hosts
   -rw-r--r--. 1 root root      2583 Feb  9 05:14 pgsql-promote.yml
   -rw-r--r--. 1 root root        15 Feb  9 05:14 README.md
   drwxr-xr-x. 5 root root        68 Feb  9 05:14 roles
   -rw-r--r--. 1 root root       226 Feb  9 05:14 setup-pgsql-replication.yml
   -rw-r--r--. 1 root root       487 Feb  9 05:14 tower-set-inventory-ha.yml
   -rw-r--r--. 1 root root      1673 Feb  9 05:14 tower-setup.yml
   -rw-r--r--. 1 root root       154 Feb  9 05:14 tower-start-services.yml
   -rw-r--r--. 1 root root       152 Feb  9 05:14 tower-stop-services.yml
   [root@bastion atower-pgsql]#
   ```

2. 2개의 inventory file 수정

   ```shell
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# grep ^inventory ansible.cfg
   inventory      = hosts
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cat << EOF > hosts
   > [tower]
   > tower1 ansible_host=192.168.1.31
   > tower2 ansible_host=192.168.1.32
   > tower3 ansible_host=192.168.1.33
   >
   > [database]
   > db1 pgsqlrep_role=master
   >
   > [database_replica]
   > db2 pgsqlrep_role=replica
   >
   > [all:vars]
   > pg_host='db1'
   > pgsqlrep_password='redhat123'
   > EOF
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cat hosts
   [tower]
   tower1 ansible_host=192.168.1.31
   tower2 ansible_host=192.168.1.32
   tower3 ansible_host=192.168.1.33
   
   [database]
   db1 pgsqlrep_role=master
   
   [database_replica]
   db2 pgsqlrep_role=replica
   
   [all:vars]
   pg_host='db1'
   pgsqlrep_password='redhat123'
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cat << EOF > ansible-tower-setup-bundle-3.8.1-1/inventory
   > [tower]
   > tower1 ansible_host=192.168.1.31
   > tower2 ansible_host=192.168.1.32
   > tower3 ansible_host=192.168.1.33
   >
   > [database]
   >
   > [all:vars]
   > admin_password='redhat123'
   >
   > pg_host='db1'
   > pg_port='5432'
   >
   > pg_database='tower1'
   > pg_username='awxdbuser1'
   > pg_password='redhat123'
   >
   > rabbitmq_port=5672
   >
   > rabbitmq_username=tower
   > rabbitmq_password='redhat123'
   > rabbitmq_cookie=secretvalue
   > rabbitmq_vhost=tower
   > rabbitmq_use_long_name=true
   >
   > # 80/443 4369/TCP 5672/TCP 25672/TCP 15672/TCP 5432/TCP
   > # Isolated Tower nodes automatically generate an RSA key for authentication;
   > # To disable this behavior, set this value to false
   > # isolated_key_generation=true
   > EOF
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cat ansible-tower-setup-bundle-3.8.1-1/inventory
   [tower]
   tower1 ansible_host=192.168.1.31
   tower2 ansible_host=192.168.1.32
   tower3 ansible_host=192.168.1.33
   
   [database]
   
   [all:vars]
   admin_password='redhat123'
   
   pg_host='db1'
   pg_port='5432'
   
   pg_database='tower1'
   pg_username='awxdbuser1'
   pg_password='redhat123'
   
   rabbitmq_port=5672
   
   rabbitmq_username=tower
   rabbitmq_password='redhat123'
   rabbitmq_cookie=secretvalue
   rabbitmq_vhost=tower
   rabbitmq_use_long_name=true
   
   # 80/443 4369/TCP 5672/TCP 25672/TCP 15672/TCP 5432/TCP
   # Isolated Tower nodes automatically generate an RSA key for authentication;
   # To disable this behavior, set this value to false
   # isolated_key_generation=true
   [root@bastion atower-pgsql]#
   ```

3. Ansible Tower 설치 시작

   ```shell
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]# cd ansible-tower-setup-bundle-3.8.1-1/
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ./setup.sh
   ...
   PLAY RECAP ******************************************************************************************************
   tower1                     : ok=158  changed=72   unreachable=0    failed=0    skipped=84   rescued=0    ignored=2
   tower2                     : ok=146  changed=64   unreachable=0    failed=0    skipped=78   rescued=0    ignored=1
   tower3                     : ok=146  changed=64   unreachable=0    failed=0    skipped=78   rescued=0    ignored=1
   
   The setup process completed successfully.
   Setup log saved to /var/log/tower/setup-2021-02-09-05:38:15.log.
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```

4. postgresql replication 세팅하기

   ```shell
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cd ..
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]# ll
   total 379744
   -rw-r--r--. 1 root root     19966 Feb  9 05:14 ansible.cfg
   drwxr-xr-x. 7 root root       230 Feb  9 05:46 ansible-tower-setup-bundle-3.8.1-1
   -rw-r--r--. 1 root root 388792591 Feb  9 05:18 ansible-tower-setup-bundle-latest.el8.tar.gz
   -rw-r--r--. 1 root root      3747 Feb  9 05:14 check-pgsql-replication.yml
   -rw-r--r--. 1 root root       216 Feb  9 05:32 hosts
   -rw-r--r--. 1 root root       227 Feb  9 05:31 hosts_bak
   -rw-r--r--. 1 root root      2583 Feb  9 05:14 pgsql-promote.yml
   -rw-r--r--. 1 root root        15 Feb  9 05:14 README.md
   drwxr-xr-x. 5 root root        68 Feb  9 05:14 roles
   -rw-r--r--. 1 root root       226 Feb  9 05:14 setup-pgsql-replication.yml
   -rw-r--r--. 1 root root       487 Feb  9 05:14 tower-set-inventory-ha.yml
   -rw-r--r--. 1 root root      1673 Feb  9 05:14 tower-setup.yml
   -rw-r--r--. 1 root root       154 Feb  9 05:14 tower-start-services.yml
   -rw-r--r--. 1 root root       152 Feb  9 05:14 tower-stop-services.yml
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts setup-pgsql-replication.yml
   ...
   PLAY RECAP ******************************************************************************************************************************************************************************************************************************
   db1                        : ok=8    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   db2                        : ok=12   changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
   tower1                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower2                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower3                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   
   ```

5. postgresql replication 확인 방법 1

   ```shell
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts check-pgsql-replication.yml
   
   PLAY [database_replica] *****************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db2]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db2]
   
   TASK [check replication status and latency] *********************************************************************
   ok: [db2]
   
   TASK [extract datetime] *****************************************************************************************
   ok: [db2] => {
       "msg": "Replication latency is 1.335519"
   }
   
   TASK [ensure replica is in recovery mode] ***********************************************************************
   ok: [db2]
   
   TASK [check recovery mode is set to true on replica(s)] *********************************************************
   ok: [db2] => {
       "msg": "Recovery mode is TRUE"
   }
   
   PLAY [database] *************************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db1]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db1]
   
   TASK [ensure master is not in recovery mode] ********************************************************************
   ok: [db1]
   
   TASK [check recovery mode is set to false on primary] ***********************************************************
   ok: [db1] => {
       "msg": "Recovery mode is FALSE"
   }
   
   TASK [get master db  configured on tower nodes] *****************************************************************
   ok: [db1 -> 192.168.1.31]
   
   TASK [check configured db for tower nodes] **********************************************************************
   ok: [db1] => {
       "msg": "Configured db is db1"
   }
   
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   db2                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

6. postgresql replication 확인 방법 2 (wal 확인)

   ```shell
   [root@bastion atower-pgsql]# ssh db1
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 06:14:19 2021 from 192.168.1.30
   [root@db1 ~]#
   [root@db1 ~]#
   [root@db1 ~]# netstat -atnp
   Active Internet connections (servers and established)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd
   tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      1762/dnsmasq
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1129/sshd
   tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1125/cupsd
   tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      36428/postmaster
   tcp        0      0 192.168.1.34:5432       192.168.1.31:56526      ESTABLISHED 39456/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:49948      ESTABLISHED 36462/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:43180      ESTABLISHED 39442/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:56474      ESTABLISHED 39354/postgres: awx
   tcp        0      0 192.168.1.34:22         192.168.1.30:33556      ESTABLISHED 39460/sshd: root [p
   tcp        0      0 192.168.1.34:5432       192.168.1.33:50758      ESTABLISHED 39448/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:43172      ESTABLISHED 39438/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:49946      ESTABLISHED 36456/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:50726      ESTABLISHED 39394/postgres: awx
   tcp        0      0 192.168.0.34:5432       192.168.0.35:34956      ESTABLISHED 38665/postgres: wal
   tcp        0      0 192.168.1.34:5432       192.168.1.32:42366      ESTABLISHED 36463/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:55718      ESTABLISHED 36464/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:49944      ESTABLISHED 36455/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:43176      ESTABLISHED 39440/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:42364      ESTABLISHED 36458/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:50764      ESTABLISHED 39451/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:56532      ESTABLISHED 39459/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:56530      ESTABLISHED 39458/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:55714      ESTABLISHED 36460/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.33:50762      ESTABLISHED 39450/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:43182      ESTABLISHED 39443/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.32:42362      ESTABLISHED 36457/postgres: awx
   tcp        0      0 192.168.1.34:5432       192.168.1.31:55716      ESTABLISHED 36461/postgres: awx
   tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd
   tcp6       0      0 :::22                   :::*                    LISTEN      1129/sshd
   tcp6       0      0 ::1:631                 :::*                    LISTEN      1125/cupsd
   tcp6       0      0 :::5432                 :::*                    LISTEN      36428/postmaster
   [root@db1 ~]#
   [root@db1 ~]#
   [root@db1 ~]# exit
   logout
   Connection to db1 closed.
   [root@bastion atower-pgsql]# ssh db2
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 06:14:17 2021 from 192.168.1.30
   [root@db2 ~]#
   [root@db2 ~]# netstat -atnp
   Active Internet connections (servers and established)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd
   tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      1848/dnsmasq
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1130/sshd
   tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1127/cupsd
   tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      36685/postmaster
   tcp        0    196 192.168.1.35:22         192.168.1.30:51122      ESTABLISHED 37261/sshd: root [p
   tcp        0      0 192.168.0.35:34956      192.168.0.34:5432       ESTABLISHED 36691/postgres: wal
   tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd
   tcp6       0      0 :::22                   :::*                    LISTEN      1130/sshd
   tcp6       0      0 ::1:631                 :::*                    LISTEN      1127/cupsd
   tcp6       0      0 :::5432                 :::*                    LISTEN      36685/postmaster
   [root@db2 ~]#
   ```

7. Tower 3개 모두 접속되는지 확인

   ![image-20210209063516688](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209063516688.png)

   ![image-20210209063532455](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209063532455.png)

   ![image-20210209063541805](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209063541805.png)

   

# DB2로 failover 시나리오

1. DB1 Service Down

   ```shell
   [root@bastion atower-pgsql]# ssh db1
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 06:18:26 2021 from 192.168.1.30
   [root@db1 ~]#
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 05:50:04 KST; 51min ago
     Process: 36425 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 36428 (postmaster)
       Tasks: 30 (limit: 49295)
      Memory: 80.8M
      CGroup: /system.slice/postgresql.service
              ├─36428 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─36429 postgres: logger process
              ├─36431 postgres: checkpointer process
              ├─36432 postgres: writer process
              ├─36433 postgres: wal writer process
              ├─36434 postgres: autovacuum launcher process
              ├─36435 postgres: stats collector process
              ├─36436 postgres: bgworker: logical replication launcher
              ├─36455 postgres: awxdbuser1 tower1 192.168.1.33(49944) idle
              ├─36456 postgres: awxdbuser1 tower1 192.168.1.33(49946) idle
              ├─36457 postgres: awxdbuser1 tower1 192.168.1.32(42362) idle
              ├─36458 postgres: awxdbuser1 tower1 192.168.1.32(42364) idle
              ├─36460 postgres: awxdbuser1 tower1 192.168.1.31(55714) idle
              ├─36461 postgres: awxdbuser1 tower1 192.168.1.31(55716) idle
              ├─36462 postgres: awxdbuser1 tower1 192.168.1.33(49948) idle
              ├─36463 postgres: awxdbuser1 tower1 192.168.1.32(42366) idle
              ├─36464 postgres: awxdbuser1 tower1 192.168.1.31(55718) idle
              ├─38665 postgres: wal sender process replica 192.168.0.35(34956) streaming 0/4035CE8
              ├─40704 postgres: awxdbuser1 tower1 192.168.1.31(57192) idle
              ├─40740 postgres: awxdbuser1 tower1 192.168.1.32(43830) idle
              ├─40742 postgres: awxdbuser1 tower1 192.168.1.32(43834) idle
              ├─40808 postgres: awxdbuser1 tower1 192.168.1.33(51408) idle
              ├─40824 postgres: awxdbuser1 tower1 192.168.1.31(57224) idle
              ├─40842 postgres: awxdbuser1 tower1 192.168.1.33(51426) idle
              ├─40844 postgres: awxdbuser1 tower1 192.168.1.31(57234) idle
              ├─40846 postgres: awxdbuser1 tower1 192.168.1.32(43848) idle
              ├─40848 postgres: awxdbuser1 tower1 192.168.1.33(51430) idle
              ├─40850 postgres: awxdbuser1 tower1 192.168.1.31(57238) idle
              ├─40852 postgres: awxdbuser1 tower1 192.168.1.32(43852) idle
              └─40855 postgres: awxdbuser1 tower1 192.168.1.33(51434) idle
   
   Feb 09 05:50:04 db1.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.463 KST [36428] LOG:  listening on IPv4 a>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.463 KST [36428] LOG:  listening on IPv6 a>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.467 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.474 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] LOG:  redirecting log out>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] HINT:  Future log output >
   Feb 09 05:50:04 db1.example.com systemd[1]: Started PostgreSQL database server.
   [root@db1 ~]#
   [root@db1 ~]# systemctl stop postgresql.service
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: inactive (dead) (thawing) since Tue 2021-02-09 06:41:39 KST; 3s ago
     Process: 36428 ExecStart=/usr/bin/postmaster -D ${PGDATA} (code=exited, status=0/SUCCESS)
     Process: 36425 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 36428 (code=exited, status=0/SUCCESS)
   
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.463 KST [36428] LOG:  listening on IPv6 a>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.467 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.474 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] LOG:  redirecting log out>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] HINT:  Future log output >
   Feb 09 05:50:04 db1.example.com systemd[1]: Started PostgreSQL database server.
   Feb 09 06:41:39 db1.example.com systemd[1]: Stopping PostgreSQL database server...
   Feb 09 06:41:39 db1.example.com systemd[1]: postgresql.service: Killing process 36429 (postmaster) with signal S>
   Feb 09 06:41:39 db1.example.com systemd[1]: postgresql.service: Succeeded.
   Feb 09 06:41:39 db1.example.com systemd[1]: Stopped PostgreSQL database server.
   [root@db1 ~]#
   
   ```

2. Tower web console 상태확인

   ![image-20210209064254259](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209064254259.png)

   ![image-20210209064304227](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209064304227.png)

   ![image-20210209064324606](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209064324606.png)

3. DB2로 failover 수행

   ```shell
   [root@db1 ~]# exit
   logout
   Connection to db1 closed.
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts pgsql-promote.yml
   
   PLAY [Promote secondary HA database to primary] *****************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db2]
   
   TASK [postgres : include_vars] **********************************************************************************
   ok: [db2] => (item=/root/atower-pgsql/roles/postgres/vars/../vars/RedHat-8.yml)
   
   TASK [postgres : include_tasks] *********************************************************************************
   skipping: [db2]
   
   TASK [postgres : include_tasks] *********************************************************************************
   skipping: [db2]
   
   TASK [determine path for pg_ctl command] ************************************************************************
   ok: [db2]
   
   TASK [if Tower postgres role does not provide an SCL prefix] ****************************************************
   skipping: [db2]
   
   TASK [pgsql-replication : Get PostgreSQL version] ***************************************************************
   ok: [db2]
   
   TASK [pgsql-replication : Set PGSQL version] ********************************************************************
   ok: [db2]
   
   TASK [Check recovery.conf] **************************************************************************************
   ok: [db2]
   
   TASK [Exit if secondary is already promoted or not in standby mode] *********************************************
   skipping: [db2]
   
   TASK [Promote secondary PostgreSQL server to primary] ***********************************************************
   changed: [db2]
   
   TASK [ensure replica is not in recovery mode] *******************************************************************
   ok: [db2]
   
   TASK [check that recovery mode is off] **************************************************************************
   ok: [db2] => {
       "msg": "Recovery mode is False"
   }
   
   PLAY RECAP ******************************************************************************************************
   db2                        : ok=9    changed=1    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

4. DB2로 failover 후, tower에 다시 re-connect(방법1)

   ```
   [root@tower1 ~]# #### Before ####
   [root@tower1 ~]# cat /etc/tower/conf.d/postgres.py
   # Ansible Tower database settings.
   
   DATABASES = {
      'default': {
          'ATOMIC_REQUESTS': True,
          'ENGINE': 'awx.main.db.profiled_pg',
          'NAME': 'tower1',
          'USER': 'awxdbuser1',
          'PASSWORD': """redhat123""",
          'HOST': 'db1',
          'PORT': '5432',
          'OPTIONS': { 'sslmode': 'prefer',
                       'sslrootcert': '/etc/pki/tls/certs/ca-bundle.crt',
          },
      }
   }
   
   [root@tower1 ~]# #### After #### 
   [root@tower1 ~]# cat /etc/tower/conf.d/postgres.py
   # Ansible Tower database settings.
   
   DATABASES = {
      'default': {
          'ATOMIC_REQUESTS': True,
          'ENGINE': 'awx.main.db.profiled_pg',
          'NAME': 'tower1',
          'USER': 'awxdbuser1',
          'PASSWORD': """redhat123""",
          'HOST': 'db2',
          'PORT': '5432',
          'OPTIONS': { 'sslmode': 'prefer',
                       'sslrootcert': '/etc/pki/tls/certs/ca-bundle.crt',
          },
      }
   }
   
   [root@tower1 ~]#
   [root@tower1 ~]# ansible-tower-service restart
   [root@tower1 ~]# ansible-tower-service status
   [root@tower1 ~]# 
   [root@tower1 ~]# ###### Tower 1~3 순으로 모두 수행 ############
   ```

5. DB2로 failover 후, tower에 다시 re-connect(방법2)

   ```
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# pwd
   /root/atower-pgsql/ansible-tower-setup-bundle-3.8.1-1
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cat inventory_failover
   [tower]
   tower1 ansible_host=192.168.1.31
   tower2 ansible_host=192.168.1.32
   tower3 ansible_host=192.168.1.33
   
   [database]
   
   [all:vars]
   admin_password='redhat123'
   
   pg_host='db2'
   pg_port='5432'
   
   pg_database='tower1'
   pg_username='awxdbuser1'
   pg_password='redhat123'
   
   rabbitmq_port=5672
   
   rabbitmq_username=tower
   rabbitmq_password='redhat123'
   rabbitmq_cookie=secretvalue
   rabbitmq_vhost=tower
   rabbitmq_use_long_name=true
   
   # 80/443 4369/TCP 5672/TCP 25672/TCP 15672/TCP 5432/TCP
   # Isolated Tower nodes automatically generate an RSA key for authentication;
   # To disable this behavior, set this value to false
   # isolated_key_generation=true
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# diff inventory_failover inventory
   11c11
   < pg_host='db2'
   ---
   > pg_host='db1'
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cp inventory_failover inventory
   cp: overwrite 'inventory'? y
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# diff inventory_failover inventory
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ./setup.sh
   ...
   PLAY RECAP ******************************************************************************************************
   tower1                     : ok=159  changed=30   unreachable=0    failed=0    skipped=82   rescued=0    ignored=0
   tower2                     : ok=148  changed=27   unreachable=0    failed=0    skipped=75   rescued=0    ignored=0
   tower3                     : ok=148  changed=27   unreachable=0    failed=0    skipped=75   rescued=0    ignored=0
   
   The setup process completed successfully.
   Setup log saved to /var/log/tower/setup-2021-02-09-06:55:35.log.
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```

6. Tower & DB2(primary) 연결확인

   ![image-20210209070010608](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209070010608.png)

   ![image-20210209070018217](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209070018217.png)

   ![image-20210209070025145](C:\Users\jakim\AppData\Roaming\Typora\typora-user-images\image-20210209070025145.png)

   

# DB1으로 failback 시나리오

1. DB1의 postgresql 서비스 재시작

   ```shell
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ssh db1
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 06:40:26 2021 from 192.168.1.30
   [root@db1 ~]#
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: inactive (dead) (thawing) since Tue 2021-02-09 06:41:39 KST; 23min ago
     Process: 36428 ExecStart=/usr/bin/postmaster -D ${PGDATA} (code=exited, status=0/SUCCESS)
     Process: 36425 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 36428 (code=exited, status=0/SUCCESS)
   
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.463 KST [36428] LOG:  listening on IPv6 a>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.467 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.474 KST [36428] LOG:  listening on Unix s>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] LOG:  redirecting log out>
   Feb 09 05:50:04 db1.example.com postmaster[36428]: 2021-02-09 05:50:04.490 KST [36428] HINT:  Future log output >
   Feb 09 05:50:04 db1.example.com systemd[1]: Started PostgreSQL database server.
   Feb 09 06:41:39 db1.example.com systemd[1]: Stopping PostgreSQL database server...
   Feb 09 06:41:39 db1.example.com systemd[1]: postgresql.service: Killing process 36429 (postmaster) with signal S>
   Feb 09 06:41:39 db1.example.com systemd[1]: postgresql.service: Succeeded.
   Feb 09 06:41:39 db1.example.com systemd[1]: Stopped PostgreSQL database server.
   [root@db1 ~]#
   [root@db1 ~]# systemctl start postgresql.service
   [root@db1 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 07:04:59 KST; 4s ago
     Process: 41179 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 41182 (postmaster)
       Tasks: 8 (limit: 49295)
      Memory: 17.1M
      CGroup: /system.slice/postgresql.service
              ├─41182 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─41184 postgres: logger process
              ├─41186 postgres: checkpointer process
              ├─41187 postgres: writer process
              ├─41188 postgres: wal writer process
              ├─41189 postgres: autovacuum launcher process
              ├─41190 postgres: stats collector process
              └─41191 postgres: bgworker: logical replication launcher
   
   Feb 09 07:04:59 db1.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.504 KST [41182] LOG:  listening on IPv4 a>
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.504 KST [41182] LOG:  listening on IPv6 a>
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.509 KST [41182] LOG:  listening on Unix s>
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.518 KST [41182] LOG:  listening on Unix s>
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.536 KST [41182] LOG:  redirecting log out>
   Feb 09 07:04:59 db1.example.com postmaster[41182]: 2021-02-09 07:04:59.536 KST [41182] HINT:  Future log output >
   Feb 09 07:04:59 db1.example.com systemd[1]: Started PostgreSQL database server.
   [root@db1 ~]#
   ```

2. DB2 -> DB1으로 replication

   ```shell
   [root@db1 ~]# exit
   logout
   Connection to db1 closed.
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cd ..
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# pwd
   /root/atower-pgsql
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ll
   total 379744
   -rw-r--r--. 1 root root     19966 Feb  9 05:14 ansible.cfg
   drwxr-xr-x. 7 root root       277 Feb  9 06:58 ansible-tower-setup-bundle-3.8.1-1
   -rw-r--r--. 1 root root 388792591 Feb  9 05:18 ansible-tower-setup-bundle-latest.el8.tar.gz
   -rw-r--r--. 1 root root      3747 Feb  9 05:14 check-pgsql-replication.yml
   -rw-r--r--. 1 root root       246 Feb  9 06:05 hosts
   -rw-r--r--. 1 root root       227 Feb  9 05:31 hosts_bak
   -rw-r--r--. 1 root root      2583 Feb  9 05:14 pgsql-promote.yml
   -rw-r--r--. 1 root root        15 Feb  9 05:14 README.md
   drwxr-xr-x. 5 root root        68 Feb  9 05:14 roles
   -rw-r--r--. 1 root root       226 Feb  9 05:14 setup-pgsql-replication.yml
   -rw-r--r--. 1 root root       487 Feb  9 05:14 tower-set-inventory-ha.yml
   -rw-r--r--. 1 root root      1673 Feb  9 05:14 tower-setup.yml
   -rw-r--r--. 1 root root       154 Feb  9 05:14 tower-start-services.yml
   -rw-r--r--. 1 root root       152 Feb  9 05:14 tower-stop-services.yml
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cp hosts hosts_failback
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# vim hosts_failback
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# cat hosts_failback
   [tower]
   tower1 ansible_host=192.168.1.31
   tower2 ansible_host=192.168.1.32
   tower3 ansible_host=192.168.1.33
   
   [database]
   db2 pgsqlrep_role=master
   
   [database_replica]
   db1 pgsqlrep_role=replica
   
   [all:vars]
   pg_host='db2'
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts_failback setup-pgsql-replication.yml
   ...
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=12   changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
   db2                        : ok=8    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower1                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower2                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower3                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

3. DB2 = primary, DB1 = standby 확인

   ```shell
   [root@bastion atower-pgsql]# ansible-playbook -i hosts_failback check-pgsql-replication.yml
   
   PLAY [database_replica] *****************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db1]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db1]
   
   TASK [check replication status and latency] *********************************************************************
   ok: [db1]
   
   TASK [extract datetime] *****************************************************************************************
   ok: [db1] => {
       "msg": "Replication latency is 4.067062"
   }
   
   TASK [ensure replica is in recovery mode] ***********************************************************************
   ok: [db1]
   
   TASK [check recovery mode is set to true on replica(s)] *********************************************************
   ok: [db1] => {
       "msg": "Recovery mode is TRUE"
   }
   
   PLAY [database] *************************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db2]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db2]
   
   TASK [ensure master is not in recovery mode] ********************************************************************
   ok: [db2]
   
   TASK [check recovery mode is set to false on primary] ***********************************************************
   ok: [db2] => {
       "msg": "Recovery mode is FALSE"
   }
   
   TASK [get master db  configured on tower nodes] *****************************************************************
   ok: [db2 -> 192.168.1.31]
   
   TASK [check configured db for tower nodes] **********************************************************************
   ok: [db2] => {
       "msg": "Configured db is db2"
   }
   
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   db2                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   
   ```

4. DB1=primary, DB2=standby 로 promote

   ```shell
   [root@db2 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 07:12:22 KST; 15min ago
     Process: 40379 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 40382 (postmaster)
       Tasks: 29 (limit: 49296)
      Memory: 92.9M
      CGroup: /system.slice/postgresql.service
              ├─40382 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─40383 postgres: logger process
              ├─40385 postgres: checkpointer process
              ├─40386 postgres: writer process
              ├─40387 postgres: wal writer process
              ├─40388 postgres: autovacuum launcher process
              ├─40389 postgres: stats collector process
              ├─40390 postgres: bgworker: logical replication launcher
              ├─40408 postgres: awxdbuser1 tower1 192.168.1.33(58916) idle
              ├─40410 postgres: awxdbuser1 tower1 192.168.1.33(58918) idle
              ├─40412 postgres: awxdbuser1 tower1 192.168.1.32(57110) idle
              ├─40413 postgres: awxdbuser1 tower1 192.168.1.32(57112) idle
              ├─40414 postgres: awxdbuser1 tower1 192.168.1.31(39714) idle
              ├─40415 postgres: awxdbuser1 tower1 192.168.1.31(39716) idle
              ├─40416 postgres: awxdbuser1 tower1 192.168.1.33(58920) idle
              ├─40417 postgres: awxdbuser1 tower1 192.168.1.32(57114) idle
              ├─40418 postgres: awxdbuser1 tower1 192.168.1.31(39718) idle
              ├─43520 postgres: awxdbuser1 tower1 192.168.1.33(59312) idle
              ├─43542 postgres: awxdbuser1 tower1 192.168.1.31(40124) idle
              ├─43581 postgres: awxdbuser1 tower1 192.168.1.32(57538) idle
              ├─43644 postgres: awxdbuser1 tower1 192.168.1.32(57544) idle
              ├─43652 postgres: awxdbuser1 tower1 192.168.1.33(59358) idle
              ├─43658 postgres: awxdbuser1 tower1 192.168.1.33(59362) idle
              ├─43661 postgres: awxdbuser1 tower1 192.168.1.31(40156) idle
              ├─43662 postgres: awxdbuser1 tower1 192.168.1.32(57556) idle
              ├─43663 postgres: awxdbuser1 tower1 192.168.1.33(59364) idle
              ├─43664 postgres: awxdbuser1 tower1 192.168.1.32(57558) idle
              ├─43666 postgres: awxdbuser1 tower1 192.168.1.31(40160) idle
              └─43667 postgres: awxdbuser1 tower1 192.168.1.31(40162) idle
   
   Feb 09 07:12:22 db2.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.878 KST [40382] LOG:  listening on IPv4 a>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.878 KST [40382] LOG:  listening on IPv6 a>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.882 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.888 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] LOG:  redirecting log out>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] HINT:  Future log output >
   Feb 09 07:12:22 db2.example.com systemd[1]: Started PostgreSQL database server.
   [root@db2 ~]#
   [root@db2 ~]# systemctl stop postgresql.service
   [root@db2 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: inactive (dead) (thawing) since Tue 2021-02-09 07:28:00 KST; 4s ago
     Process: 40382 ExecStart=/usr/bin/postmaster -D ${PGDATA} (code=exited, status=0/SUCCESS)
     Process: 40379 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 40382 (code=exited, status=0/SUCCESS)
   
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.878 KST [40382] LOG:  listening on IPv6 a>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.882 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.888 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] LOG:  redirecting log out>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] HINT:  Future log output >
   Feb 09 07:12:22 db2.example.com systemd[1]: Started PostgreSQL database server.
   Feb 09 07:28:00 db2.example.com systemd[1]: Stopping PostgreSQL database server...
   Feb 09 07:28:00 db2.example.com systemd[1]: postgresql.service: Killing process 40383 (postmaster) with signal S>
   Feb 09 07:28:00 db2.example.com systemd[1]: postgresql.service: Succeeded.
   Feb 09 07:28:00 db2.example.com systemd[1]: Stopped PostgreSQL database server.
   [root@db2 ~]#
   [root@db2 ~]# exit
   logout
   Connection to db2 closed.
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts_failback pgsql-promote.yml
   
   PLAY [Promote secondary HA database to primary] *****************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db1]
   
   TASK [postgres : include_vars] **********************************************************************************
   ok: [db1] => (item=/root/atower-pgsql/roles/postgres/vars/../vars/RedHat-8.yml)
   
   TASK [postgres : include_tasks] *********************************************************************************
   skipping: [db1]
   
   TASK [postgres : include_tasks] *********************************************************************************
   skipping: [db1]
   
   TASK [determine path for pg_ctl command] ************************************************************************
   ok: [db1]
   
   TASK [if Tower postgres role does not provide an SCL prefix] ****************************************************
   skipping: [db1]
   
   TASK [pgsql-replication : Get PostgreSQL version] ***************************************************************
   ok: [db1]
   
   TASK [pgsql-replication : Set PGSQL version] ********************************************************************
   ok: [db1]
   
   TASK [Check recovery.conf] **************************************************************************************
   ok: [db1]
   
   TASK [Exit if secondary is already promoted or not in standby mode] *********************************************
   skipping: [db1]
   
   TASK [Promote secondary PostgreSQL server to primary] ***********************************************************
   changed: [db1]
   
   TASK [ensure replica is not in recovery mode] *******************************************************************
   ok: [db1]
   
   TASK [check that recovery mode is off] **************************************************************************
   ok: [db1] => {
       "msg": "Recovery mode is False"
   }
   
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=9    changed=1    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

5. DB1 = primary, DB2 = standby 다시 replication 설정

   ```shell
   [root@bastion atower-pgsql]# ssh db2
   Activate the web console with: systemctl enable --now cockpit.socket
   
   This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
   To register this system, run: insights-client --register
   
   Last login: Tue Feb  9 07:27:15 2021 from 192.168.1.30
   [root@db2 ~]#
   [root@db2 ~]#
   [root@db2 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: inactive (dead) (thawing) since Tue 2021-02-09 07:28:00 KST; 5min ago
     Process: 40382 ExecStart=/usr/bin/postmaster -D ${PGDATA} (code=exited, status=0/SUCCESS)
     Process: 40379 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 40382 (code=exited, status=0/SUCCESS)
   
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.878 KST [40382] LOG:  listening on IPv6 a>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.882 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.888 KST [40382] LOG:  listening on Unix s>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] LOG:  redirecting log out>
   Feb 09 07:12:22 db2.example.com postmaster[40382]: 2021-02-09 07:12:22.905 KST [40382] HINT:  Future log output >
   Feb 09 07:12:22 db2.example.com systemd[1]: Started PostgreSQL database server.
   Feb 09 07:28:00 db2.example.com systemd[1]: Stopping PostgreSQL database server...
   Feb 09 07:28:00 db2.example.com systemd[1]: postgresql.service: Killing process 40383 (postmaster) with signal S>
   Feb 09 07:28:00 db2.example.com systemd[1]: postgresql.service: Succeeded.
   Feb 09 07:28:00 db2.example.com systemd[1]: Stopped PostgreSQL database server.
   [root@db2 ~]#
   [root@db2 ~]# systemctl start postgresql.service
   [root@db2 ~]# systemctl status postgresql.service
   ● postgresql.service - PostgreSQL database server
      Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)
      Active: active (running) (thawing) since Tue 2021-02-09 07:33:19 KST; 1s ago
     Process: 43832 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
    Main PID: 43835 (postmaster)
       Tasks: 14 (limit: 49296)
      Memory: 31.2M
      CGroup: /system.slice/postgresql.service
              ├─43835 /usr/bin/postmaster -D /var/lib/pgsql/data
              ├─43837 postgres: logger process
              ├─43839 postgres: checkpointer process
              ├─43840 postgres: writer process
              ├─43841 postgres: wal writer process
              ├─43842 postgres: autovacuum launcher process
              ├─43843 postgres: stats collector process
              ├─43844 postgres: bgworker: logical replication launcher
              ├─43845 postgres: awxdbuser1 tower1 192.168.1.32(44460) idle
              ├─43848 postgres: awxdbuser1 tower1 192.168.1.31(55254) idle
              ├─43849 postgres: awxdbuser1 tower1 192.168.1.31(55256) idle
              ├─43850 postgres: awxdbuser1 tower1 192.168.1.31(55258) idle
              ├─43853 postgres: awxdbuser1 tower1 192.168.1.33(46202) idle
              └─43854 postgres: awxdbuser1 tower1 192.168.1.33(46204) idle
   
   Feb 09 07:33:18 db2.example.com systemd[1]: Starting PostgreSQL database server...
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.027 KST [43835] LOG:  listening on IPv4 a>
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.027 KST [43835] LOG:  listening on IPv6 a>
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.035 KST [43835] LOG:  listening on Unix s>
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.042 KST [43835] LOG:  listening on Unix s>
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.058 KST [43835] LOG:  redirecting log out>
   Feb 09 07:33:19 db2.example.com postmaster[43835]: 2021-02-09 07:33:19.058 KST [43835] HINT:  Future log output >
   Feb 09 07:33:19 db2.example.com systemd[1]: Started PostgreSQL database server.
   [root@db2 ~]#
   [root@db2 ~]# exit
   logout
   Connection to db2 closed.
   [root@bastion atower-pgsql]#
   [root@bastion atower-pgsql]# ansible-playbook -i hosts setup-pgsql-replication.yml
   ...
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=8    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   db2                        : ok=12   changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
   tower1                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower2                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   tower3                     : ok=4    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

6. DB1로 failback 후, tower에 다시 re-connect(방법1)

   ```shell
   [root@bastion atower-pgsql]# 
   [root@bastion atower-pgsql]# cd ansible-tower-setup-bundle-3.8.1-1/
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ll
   total 72
   -rw-r--r--.  1 root root   626 Jan 13 20:43 backup.yml
   drwxr-xr-x.  4 root root    28 Jan 13 20:44 bundle
   drwxr-xr-x.  3 root root    33 Jan 13 20:44 collections
   drwxr-xr-x.  2 root root    17 Jan 13 20:43 group_vars
   -rw-r--r--.  1 root root  8521 Jan 13 20:43 install.yml
   -rw-r--r--.  1 root root   628 Feb  9 06:54 inventory
   -rw-r--r--.  1 root root  2915 Feb  9 05:33 inventory_bak
   -rw-r--r--.  1 root root   628 Feb  9 06:52 inventory_failover
   -rw-r--r--.  1 root root   628 Feb  9 06:54 inventory_org
   drwxr-xr-x.  3 root root  8192 Jan 13 20:43 licenses
   -rw-r--r--.  1 root root  2506 Jan 13 20:43 README.md
   -rw-r--r--.  1 root root  1335 Jan 13 20:43 rekey.yml
   -rw-r--r--.  1 root root  3492 Jan 13 20:43 restore.yml
   drwxr-xr-x. 21 root root  4096 Jan 13 20:43 roles
   -rwxr-xr-x.  1 root root 10819 Jan 13 20:43 setup.sh
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cp inventory_org inventory
   cp: overwrite 'inventory'? y
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# diff inventory inventory_failover
   11c11
   < pg_host='db1'
   ---
   > pg_host='db2'
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# ./setup.sh
   ...
   PLAY RECAP ******************************************************************************************************
   tower1                     : ok=159  changed=30   unreachable=0    failed=0    skipped=82   rescued=0    ignored=0
   tower2                     : ok=148  changed=27   unreachable=0    failed=0    skipped=75   rescued=0    ignored=0
   tower3                     : ok=148  changed=27   unreachable=0    failed=0    skipped=75   rescued=0    ignored=0
   
   The setup process completed successfully.
   Setup log saved to /var/log/tower/setup-2021-02-09-07:39:03.log.
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   ```

7. DB1 = primary, DB2 = standby 설정확인

   ```shell
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]#
   [root@bastion ansible-tower-setup-bundle-3.8.1-1]# cd ..
   [root@bastion atower-pgsql]# ansible-playbook -i hosts check-pgsql-replication.yml
   
   PLAY [database_replica] *****************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db2]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db2]
   
   TASK [check replication status and latency] *********************************************************************
   ok: [db2]
   
   TASK [extract datetime] *****************************************************************************************
   ok: [db2] => {
       "msg": "Replication latency is 13.222286"
   }
   
   TASK [ensure replica is in recovery mode] ***********************************************************************
   ok: [db2]
   
   TASK [check recovery mode is set to true on replica(s)] *********************************************************
   ok: [db2] => {
       "msg": "Recovery mode is TRUE"
   }
   
   PLAY [database] *************************************************************************************************
   
   TASK [Gathering Facts] ******************************************************************************************
   ok: [db1]
   
   TASK [set_fact] *************************************************************************************************
   skipping: [db1]
   
   TASK [ensure master is not in recovery mode] ********************************************************************
   ok: [db1]
   
   TASK [check recovery mode is set to false on primary] ***********************************************************
   ok: [db1] => {
       "msg": "Recovery mode is FALSE"
   }
   
   TASK [get master db  configured on tower nodes] *****************************************************************
   ok: [db1 -> 192.168.1.31]
   
   TASK [check configured db for tower nodes] **********************************************************************
   ok: [db1] => {
       "msg": "Configured db is db1"
   }
   
   PLAY RECAP ******************************************************************************************************
   db1                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   db2                        : ok=5    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
   
   [root@bastion atower-pgsql]#
   ```

   

